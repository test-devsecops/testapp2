# This workflow will trigger SCA scans for 3rd party JAR files from the artifactory

name: Run 3rd party SCA scans

on: 
    push:
        branches:
          - release/prod

jobs:
    third-party-scan:
        runs-on: ubuntu-latest
        steps:
            - name: Pull file from repository
              uses: actions/checkout@v4
              with:
                  repository: kbase/jars
                  ref: master
                  path: lib/jars/amazon/V1/ion-java-1.4.0.jar
              # run: |
              #     #!/bin/sh
              #     REPO_SRC=https://github.com/kbase/jars.git

            - name: Move file to root folder
              run: |
                  mkdir test
                  mv ./lib/jars/amazon/V1/ion-java-1.4.0.jar ./test
                  ls -al ./test
            
            - name: Install CX CLI
              run: |
                  wget https://github.com/Checkmarx/ast-cli/releases/download/2.3.20/ast-cli_2.3.20_linux_x64.tar.gz
                  tar -xzvf ast-cli_2.3.20_linux_x64.tar.gz
                  chmod +x cx
                  sudo mv cx /usr/local/bin/

            - name: Print Variables and secrets
              run: |
                  echo "BASE URI = ${{vars.CX_TENANT_URL}}"
                  echo "TENANT = ${{vars.CX_TENANT_NAME}}"
                  echo "CLIENT ID = ${{vars.CX_CLIENT_ID}}"
                  echo "TOKEN = ${{secrets.CX_TOKEN}}"
            
            - name: Run CX scan
              run: |
                  cx scan create -s ./test \
                  --project-name "test" \
                  --branch "$(echo ${{ github.head_ref || github.ref }} | sed -e 's#refs/heads/##g')" \
                  --base-uri "${{vars.CX_TENANT_URL}}" \
                  --tenant "${{vars.CX_TENANT_NAME}}" \
                  --client-id "${{vars.CX_CLIENT_ID}}" \
                  --client-secret "eyJhbGciOiJIUzUxMiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICI5MzUzYmQ3Mi0yYWRjLTQwNzctOWYxMy0yOTY2Mzc2Yzk2MWUifQ.eyJpYXQiOjE3NDIyNjEyNDMsImp0aSI6IjM1MGQ0YzkwLWZkZGQtNGM1YS1hNGM1LWFiODBmNmE4ZmQxNCIsImlzcyI6Imh0dHBzOi8vZXUtMi5pYW0uY2hlY2ttYXJ4Lm5ldC9hdXRoL3JlYWxtcy9wcnVkZW50aWFsLW9uZSIsImF1ZCI6Imh0dHBzOi8vZXUtMi5pYW0uY2hlY2ttYXJ4Lm5ldC9hdXRoL3JlYWxtcy9wcnVkZW50aWFsLW9uZSIsInN1YiI6ImE4MjM1NmRlLWU2YTgtNDc4Ny04NGVlLTc2ZTE2NmUzYzc1YiIsInR5cCI6Ik9mZmxpbmUiLCJhenAiOiJhc3QtYXBwIiwic2lkIjoiZGJmMjUyNGUtMTNlZi00MDBkLWFlNGMtYjVkNWE4ODIwNGQ4Iiwic2NvcGUiOiJyb2xlcyBpYW0tYXBpIGFzdC1hcGkgZW1haWwgcHJvZmlsZSBvZmZsaW5lX2FjY2VzcyJ9.D8YRo4rfDKWOYJJE4xVvRwXJ69hRE5WdooaCEBKgzu4-ENSoObMxgi7EWQYaASDhT6HWgDadjvQsTG2zl_fsEQ" \
                  --scan-types sca \
                  --file-filter *.jar
        continue-on-error: false
